#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Cookie ç®¡ç†å·¥å…·

ç”¨äºæŸ¥çœ‹ã€åˆ é™¤ä¿å­˜çš„æµè§ˆå™¨ Cookie
"""

import json
import os
import sys
from datetime import datetime

COOKIE_FILE = '.jable_cookies.json'


def show_cookies():
    """æ˜¾ç¤ºä¿å­˜çš„ Cookie"""
    if not os.path.exists(COOKIE_FILE):
        print("âŒ æœªæ‰¾åˆ°ä¿å­˜çš„ Cookie æ–‡ä»¶")
        return

    with open(COOKIE_FILE, 'r', encoding='utf-8') as f:
        cookies = json.load(f)

    print("="*60)
    print(f"ğŸ“¦ å·²ä¿å­˜çš„ Cookie ({len(cookies)} ä¸ª)")
    print("="*60)
    print()

    # æŒ‰åŸŸååˆ†ç»„
    domains = {}
    for cookie in cookies:
        domain = cookie.get('domain', 'unknown')
        if domain not in domains:
            domains[domain] = []
        domains[domain].append(cookie)

    for domain, domain_cookies in domains.items():
        print(f"ğŸŒ åŸŸå: {domain}")
        print(f"   Cookie æ•°é‡: {len(domain_cookies)}")
        print()

        for cookie in domain_cookies:
            name = cookie.get('name', 'N/A')
            value = cookie.get('value', '')
            secure = 'ğŸ”’' if cookie.get('secure', False) else 'ğŸ”“'
            http_only = 'HTTP-Only' if cookie.get('httpOnly', False) else 'JSå¯è®¿é—®'

            # æˆªæ–­è¿‡é•¿çš„å€¼
            if len(value) > 50:
                value = value[:47] + '...'

            print(f"   {secure} {name}")
            print(f"      å€¼: {value}")
            print(f"      ç±»å‹: {http_only}")

            # æ˜¾ç¤ºè¿‡æœŸæ—¶é—´
            if 'expires' in cookie:
                expires = cookie['expires']
                if expires > 0:
                    # Unix timestamp è½¬æ¢ä¸ºæ—¥æœŸ
                    try:
                        dt = datetime.fromtimestamp(expires)
                        print(f"      è¿‡æœŸ: {dt.strftime('%Y-%m-%d %H:%M:%S')}")
                    except:
                        print(f"      è¿‡æœŸ: {expires}")
            print()

    # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    file_size = os.path.getsize(COOKIE_FILE)
    file_time = datetime.fromtimestamp(os.path.getmtime(COOKIE_FILE))
    print("-"*60)
    print(f"ğŸ“„ æ–‡ä»¶: {os.path.abspath(COOKIE_FILE)}")
    print(f"ğŸ“Š å¤§å°: {file_size} å­—èŠ‚")
    print(f"ğŸ• æœ€åä¿®æ”¹: {file_time.strftime('%Y-%m-%d %H:%M:%S')}")


def delete_cookies():
    """åˆ é™¤ä¿å­˜çš„ Cookie"""
    if not os.path.exists(COOKIE_FILE):
        print("âŒ æœªæ‰¾åˆ°ä¿å­˜çš„ Cookie æ–‡ä»¶")
        return

    print("âš ï¸  å³å°†åˆ é™¤ä¿å­˜çš„ Cookie æ–‡ä»¶")
    print(f"   æ–‡ä»¶: {os.path.abspath(COOKIE_FILE)}")
    print()

    # ç¡®è®¤
    try:
        confirm = input("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ(y/N): ").strip().lower()
        if confirm == 'y' or confirm == 'yes':
            os.remove(COOKIE_FILE)
            print("âœ… Cookie æ–‡ä»¶å·²åˆ é™¤")
        else:
            print("âŒ å–æ¶ˆåˆ é™¤")
    except KeyboardInterrupt:
        print("\nâŒ å–æ¶ˆåˆ é™¤")


def export_cookies():
    """å¯¼å‡º Cookie ä¸ºæ˜“è¯»æ ¼å¼"""
    if not os.path.exists(COOKIE_FILE):
        print("âŒ æœªæ‰¾åˆ°ä¿å­˜çš„ Cookie æ–‡ä»¶")
        return

    with open(COOKIE_FILE, 'r', encoding='utf-8') as f:
        cookies = json.load(f)

    # å¯¼å‡ºä¸º Netscape æ ¼å¼ï¼ˆå¯ç”¨äº curl ç­‰å·¥å…·ï¼‰
    output_file = 'jable_cookies_export.txt'

    with open(output_file, 'w', encoding='utf-8') as f:
        f.write("# Netscape HTTP Cookie File\n")
        f.write("# This file was generated by manage_cookies.py\n")
        f.write("# This file can be used with curl: curl -b jable_cookies_export.txt URL\n\n")

        for cookie in cookies:
            domain = cookie.get('domain', '')
            flag = 'TRUE' if domain.startswith('.') else 'FALSE'
            path = cookie.get('path', '/')
            secure = 'TRUE' if cookie.get('secure', False) else 'FALSE'
            expires = int(cookie.get('expires', 0))
            name = cookie.get('name', '')
            value = cookie.get('value', '')

            f.write(f"{domain}\t{flag}\t{path}\t{secure}\t{expires}\t{name}\t{value}\n")

    print(f"âœ… Cookie å·²å¯¼å‡ºåˆ°: {os.path.abspath(output_file)}")
    print(f"   å¯ç”¨äº curl: curl -b {output_file} <URL>")


def show_help():
    """æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"""
    print("Cookie ç®¡ç†å·¥å…·")
    print()
    print("ç”¨æ³•:")
    print("  python3 manage_cookies.py [å‘½ä»¤]")
    print()
    print("å‘½ä»¤:")
    print("  show     æ˜¾ç¤ºä¿å­˜çš„ Cookieï¼ˆé»˜è®¤ï¼‰")
    print("  delete   åˆ é™¤ä¿å­˜çš„ Cookie")
    print("  export   å¯¼å‡º Cookie ä¸º Netscape æ ¼å¼")
    print("  help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯")
    print()
    print("ç¤ºä¾‹:")
    print("  python3 manage_cookies.py")
    print("  python3 manage_cookies.py show")
    print("  python3 manage_cookies.py delete")
    print("  python3 manage_cookies.py export")


def main():
    if len(sys.argv) < 2:
        command = 'show'
    else:
        command = sys.argv[1].lower()

    if command == 'show':
        show_cookies()
    elif command == 'delete':
        delete_cookies()
    elif command == 'export':
        export_cookies()
    elif command == 'help' or command == '-h' or command == '--help':
        show_help()
    else:
        print(f"âŒ æœªçŸ¥å‘½ä»¤: {command}")
        print()
        show_help()


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nğŸ‘‹ å†è§ï¼")
    except Exception as e:
        print(f"\nâŒ é”™è¯¯: {str(e)}")
